name: Security Scans

on:
  workflow_call:
    inputs:
      # The image reference generated by a build job.
      image_url:
        description: "An image_url of the form registry/repository:tag."
        required: false
        type: string
      auth_project_number:
        description: "The GCP Project Number used for authentication. A 12-digit number used as a unique identifier for the project. Used to find workload identity pool."
        required: true
        type: string
      workload_identity_provider_override:
        description: "The ID of the provider to use for authentication. Only used for overriding the default workload identity provider based on project number. It should be in the format of `projects/{{project}}/locations/global/workloadIdentityPools/{{workload_identity_pool_id}}/providers/{{workload_identity_pool_provider_id}}`"
        required: false
        type: string
      service_account:
        description: "The GCP service account connected to the identity pool that will be used by Terraform"
        required: true
        type: string
      trivy:
        description: "A boolean which determines whether or not trivy vulnerability scan will be run. Defaults to true"
        required: false
        default: true
        type: boolean
      tfsec:
        description: "A boolean which determines whether or not TFSec security scan will be run. Defaults to true"
        required: false
        default: true
        type: boolean
      allow_severity_level:
        description: 'A string which determines the level of severity the security scans can find while still succeeding workflows. Only "not_allowed", "high" and "critical" values are allowed. Note that these values are case sensitive.'
        required: false
        default: not_allowed
        type: string

env:
  WORKLOAD_IDENTITY_PROVIDER_OVERRIDE: ${{ inputs.workload_identity_provider_override }}
  AUTH_PROJECT_NUMBER: ${{ inputs.auth_project_number }}
  SERVICE_ACCOUNT: ${{ inputs.service_account }}
  IMAGE_URL: ${{ inputs.image_url }}
  ATTESTOR_PROJECT_ID: kubernetes-dev-94b9
  REGISTRY: ghcr.io
  BRANCH: ${{ github.ref_name }}
  HEAD_REF: ${{ github.head_ref }}
  EVENT_NAME: ${{ github.event_name }}
  ALLOW_SEVERITY_LEVEL: ${{ inputs.allow_severity_level }}

jobs:
  setup-env:
    runs-on: ubuntu-latest
    outputs:
      WORKLOAD_IDENTITY_PROVIDER: ${{ steps.set-output.outputs.WORKLOAD_IDENTITY_PROVIDER }}
    steps:
      - name: Set vars
        id: set-output
        run: |
          PRODUCT_NAME=$(echo $SERVICE_ACCOUNT | sed 's/-deploy.*//')
          DEFAULT_WORKLOAD_IDENTITY="projects/$AUTH_PROJECT_NUMBER/locations/global/workloadIdentityPools/$PRODUCT_NAME-deploy-pool/providers/github-provider"
          OVERRIDE=$WORKLOAD_IDENTITY_PROVIDER_OVERRIDE
          PROVIDER=${OVERRIDE:-$DEFAULT_WORKLOAD_IDENTITY}
          echo "WORKLOAD_IDENTITY_PROVIDER=$PROVIDER" >> $GITHUB_OUTPUT
      - name: Check severity level
        if: inputs.allow_severity_level != 'not_allowed' && inputs.allow_severity_level != 'high' && inputs.allow_severity_level != 'critical'
        run: |
          echo "Error: The input 'allow_severity_level' was not one of the allowed strings, 'high', 'critical' or 'not_allowed'.";
          exit 1;

  tfsec:
    name: TFSec
    if: inputs.tfsec == true && github.event.pull_request.draft == false
    needs: [setup-env]
    runs-on: ubuntu-latest
    # Use the Bash shell regardless whether the GitHub Actions runner is ubuntu-latest, macos-latest, or windows-latest
    defaults:
      run:
        shell: bash
    steps:
      # Checkout the repository to the GitHub Actions runner
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run tfsec
        id: tfsec
        uses: aquasecurity/tfsec-sarif-action@21ded20e8ca120cd9d3d6ab04ef746477542a608
        with:
          sarif_file: tfsec.sarif

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: tfsec.sarif

  trivy:
    name: Trivy
    if: inputs.trivy == true && inputs.image_url != '' && github.event.pull_request.draft == false
    needs: [setup-env]
    runs-on: ubuntu-latest
    # Use the Bash shell regardless whether the GitHub Actions runner is ubuntu-latest, macos-latest, or windows-latest
    defaults:
      run:
        shell: bash
    permissions:
      contents: read
      packages: write
      # required for authentication to GCP
      id-token: write
      actions: read
      security-events: write
    env:
      WORKLOAD_IDENTITY_PROVIDER: ${{ needs.setup-env.outputs.WORKLOAD_IDENTITY_PROVIDER }}
    steps:
      # Checkout the repository to the GitHub Actions runner
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log into registry
        uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker pull image
        run: docker pull $IMAGE_URL

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@9ab158e8597f3b310480b9a69402b419bc03dbd5
        with:
          image-ref: ${{ env.IMAGE_URL }}
          format: sarif
          output: trivy-results.sarif
          severity: UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL
          timeout: 15m

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: trivy-results.sarif

      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Get Image Digest URL from Image Tag URL
        id: image-digest-url
        run: |
          # If image_url = registry/repository@digest
          if [[ "$IMAGE_URL" == *"@"* ]] 
          then
            image_digest_url="$IMAGE_URL"
          else
            # Convert registry/repository:tag to registry/repository@digest
            image_tag_url=$IMAGE_URL
            digest=$(docker manifest inspect $image_tag_url -v | jq -r .Descriptor.digest)
            base_image_url=${image_tag_url%:*}
            image_digest_url="${base_image_url}@${digest}"
          fi
          echo "image_url=$image_digest_url" >> $GITHUB_OUTPUT

      - name: Check if already attested by Trivy-Scan attestor
        id: get-attestation
        run: |
          attestation=$(gcloud container binauthz attestations list --project="$ATTESTOR_PROJECT_ID" --attestor="projects/$ATTESTOR_PROJECT_ID/attestors/Trivy-Scan" --artifact-url="${{ steps.image-digest-url.outputs.image_url }}")
          attestationoutput=$(printf '%s' $attestation | jq --raw-input --slurp '.' --join-output)
          echo "attestation=$attestationoutput" >> $GITHUB_OUTPUT

      - name: Perform Trivy-Scan attestation
        id: attest-kartverket-kontekst
        if: steps.get-attestation.outputs.attestation == ''
        run: |
          gcloud beta container binauthz attestations sign-and-create \
            --project="$ATTESTOR_PROJECT_ID" \
            --artifact-url="${{ steps.image-digest-url.outputs.image_url }}" \
            --attestor="Trivy-Scan" \
            --attestor-project="$ATTESTOR_PROJECT_ID" \
            --keyversion-project="$ATTESTOR_PROJECT_ID" \
            --keyversion-location="europe-north1" \
            --keyversion-keyring="Attestor-Keyring" \
            --keyversion-key="Trivy-Scan-Key" \
            --keyversion="1"
          echo Attestation succeded

  check-github-security:
    name: Check Github Security Code Scanning
    needs: [tfsec, trivy, setup-env]
    runs-on: ubuntu-latest
    # Use the Bash shell regardless whether the GitHub Actions runner is ubuntu-latest, macos-latest, or windows-latest
    defaults:
      run:
        shell: bash
    env:
      WORKLOAD_IDENTITY_PROVIDER: ${{ needs.setup-env.outputs.WORKLOAD_IDENTITY_PROVIDER }}
    steps:
      # Checkout the repository to the GitHub Actions runner
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set high and critical severity outputs
        id: severity_check_outputs
        run: |
          severity_check_high=$(curl -s -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/${{ github.repository }}/code-scanning/alerts?ref=${{github.ref}} | jq '[.[] | select(.state == "open" and (.rule.security_severity_level == "high"))] | any') 
          severity_check_critical=$(curl -s -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/${{ github.repository }}/code-scanning/alerts?ref=${{github.ref}} | jq '[.[] | select(.state == "open" and (.rule.security_severity_level == "critical"))] | any')
          echo "severity_check_high=$severity_check_high" >> $GITHUB_OUTPUT
          echo "severity_check_critical=$severity_check_critical" >> $GITHUB_OUTPUT

      # Returns 'true' if there is Code Scanning alert with 'high' or 'critical' security severity level
      - name: Succeed or fail based on severity
        id: severity_check
        run: |
          pr_number=$( echo $BRANCH | sed 's/\/.*//');

          if [[ ${{ steps.severity_check_outputs.outputs.severity_check_high == 'false' && steps.severity_check_outputs.outputs.severity_check_critical == 'false' }} == 'true' ]]
          then
            echo "Success! No high or critical code scanning alerts.";
            exit 0;
          fi

          if [[ $ALLOW_SEVERITY_LEVEL == 'not_allowed' ]]
          then
            if [[ $EVENT_NAME == 'pull_request' ]]
            then
              echo "Error: High or critical vulnerabilities detected on pull-request. Go to the Code Scanning section of the Github Security-tab and search for 'is:open pr:$pr_number' to review these vulnerabilities.";
              exit 1;
            elif [[ ($BRANCH == 'main' || $BRANCH == 'master')]]
            then
              echo "Error: High or critical vulnerabilities detected on main/master branch. Go to the Code Scanning section of the Github Security-tab to review these vulnerabilities.";
              exit 1;
            elif [[ $EVENT_NAME == 'workflow_dispatch' ]]
            then
              echo "Error: High or critical vulnerabilities detected on workflow-dispatch. Go to the Code Scanning section of the Github Security-tab and review vulnerabilities related to your workflow dispatch run.";
              exit 1;
            fi

          elif [[ $ALLOW_SEVERITY_LEVEL == 'high' ]]
          then
            if [[ ${{ steps.severity_check_outputs.outputs.severity_check_critical }} == 'true' ]]
            then
              echo "Only high vulnerabilities detected! Allowing due to input ALLOW_SEVERITY_LEVEL being set to high.";
              exit 0;
            fi

            if [[ $EVENT_NAME == 'pull_request' ]]
            then
              echo "Error: Critical vulnerabilities detected on pull-request. Go to the Code Scanning section of the Github Security-tab and search for 'is:open pr:$pr_number' to review these vulnerabilities.";
              exit 1;
            elif [[ ($BRANCH == 'main' || $BRANCH == 'master')]]
            then
              echo "Error: Critical vulnerabilities detected on main/master branch. Go to the Code Scanning section of the Github Security-tab to review these vulnerabilities.";
              exit 1;
            elif [[ $EVENT_NAME == 'workflow_dispatch' ]]
            then
              echo "Error: Critical vulnerabilities detected on workflow-dispatch. Go to the Code Scanning section of the Github Security-tab and review vulnerabilities related to your workflow dispatch run.";
              exit 1;
            fi

          elif [[ $ALLOW_SEVERITY_LEVEL == 'critical' ]]
          then
            echo "High or critical vulnerabilities detected! Allowing due to input ALLOW_SEVERITY_LEVEL being set to critical.";
            exit 0;
          fi

  attest:
    name: Attest Github Security Code Scanning
    if: inputs.image_url != ''
    needs: [tfsec, trivy, check-github-security, setup-env]
    runs-on: ubuntu-latest
    # Use the Bash shell regardless whether the GitHub Actions runner is ubuntu-latest, macos-latest, or windows-latest
    defaults:
      run:
        shell: bash
    env:
      WORKLOAD_IDENTITY_PROVIDER: ${{ needs.setup-env.outputs.WORKLOAD_IDENTITY_PROVIDER }}
    steps:
      # Checkout the repository to the GitHub Actions runner
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Log into registry
        uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Image Digest URL from Image Tag URL
        id: image-digest-url
        run: |
          # If image_url = registry/repository@digest
          if [[ "$IMAGE_URL" == *"@"* ]] 
          then
            image_digest_url="$IMAGE_URL"
          else
            # Convert registry/repository:tag to registry/repository@digest
            image_tag_url=$IMAGE_URL
            digest=$(docker manifest inspect $image_tag_url -v | jq -r .Descriptor.digest)
            base_image_url=${image_tag_url%:*}
            image_digest_url="${base_image_url}@${digest}"
          fi
          echo "image_url=$image_digest_url" >> $GITHUB_OUTPUT

      - name: Check if already attested by Security-Scan attestor
        id: get-attestation
        run: |
          attestation=$(gcloud container binauthz attestations list --project="$ATTESTOR_PROJECT_ID" --attestor="projects/$ATTESTOR_PROJECT_ID/attestors/Security-Scan" --artifact-url="${{ steps.image-digest-url.outputs.image_url }}")
          attestationoutput=$(printf '%s' $attestation | jq --raw-input --slurp '.' --join-output)
          echo "attestation=$attestationoutput" >> $GITHUB_OUTPUT

      - name: Perform Security-Scan attestation
        id: attest-kartverket-kontekst
        if: steps.get-attestation.outputs.attestation == ''
        run: |
          gcloud beta container binauthz attestations sign-and-create \
            --project="$ATTESTOR_PROJECT_ID" \
            --artifact-url="${{ steps.image-digest-url.outputs.image_url }}" \
            --attestor="Security-Scan" \
            --attestor-project="$ATTESTOR_PROJECT_ID" \
            --keyversion-project="$ATTESTOR_PROJECT_ID" \
            --keyversion-location="europe-north1" \
            --keyversion-keyring="Attestor-Keyring" \
            --keyversion-key="Security-Scan-Key" \
            --keyversion="1"
          echo Attestation succeded
