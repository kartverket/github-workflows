name: Run Terraform

on:
  workflow_call:
    inputs:
      workload_identity_provider:
        required: true
        type: string
      service_account:
        required: true
        type: string
      image_url:
        required: false
        type: string
        default: ''
    outputs:
      image_url_with_digest: 
        description: "Image URL with sha digest"
        value: ${{ jobs.get-digest.outputs.output1 }}


jobs:
  get-digest:
    name: Get Image Digest
    runs-on: ubuntu-latest
    outputs: 
      output1: ${{ steps.pull-inspect-image.outputs.msg }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v0
        with:
          workload_identity_provider: ${{ inputs.workload_identity_provider }}
          service_account: ${{ inputs.service_account }}

      - name: Pull and inspect image
        id: pull-inspect-image
        run: |
          docker pull ${{ inputs.image_url}}
          mystr=$(docker inspect --format='{{index .RepoDigests 0}}' ${{ inputs.image_url}})
          msg=$(printf '%s' $mystr | jq --raw-input --slurp '.' --join-output)
          echo "::set-output name=msg::$msg"

      - name: Get image digest 
        id: get-digestt
        run: |
          echo "${{steps.pull-inspect-image.outputs.msg}}"
